<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>atproto bluesky post embed blog demo</title>
<script>
    const $ = document.querySelector.bind(document)
    let instance = null
    let jwt = null
    async function xrpc(xrpc_method, {params = {}, data = null}) {
        let api = new URL(`https://${instance}/xrpc/${xrpc_method}`)
        let searchParams = new URLSearchParams()
        for (const [key, value] of Object.entries(params)) {
            searchParams.set(key, value)
        }
        api.search = searchParams.toString()

        let method = 'GET'
        let headers = {}
        let body = null

        if (jwt !== null) {
            headers['Authorization'] = `Bearer ${jwt}`
        }

        if (data) {
            method = 'POST'
            if (data instanceof File) {
                headers['Content-Type'] = file.type
                body = await fetch(file).then(r => r.blob())
            } else {
                headers['Content-Type'] = 'application/json'
                body = JSON.stringify(data)
            }
        }
        let response = await fetch(api.toString(), {headers, method, body})
        return await response.json()
    }
    async function auth() {
        instance = $('#instance').value
        let handle = $('#handle').value
        let password = $('#password').value
        let data = {
            identifier: handle,
            password
        }
        let result = await xrpc('com.atproto.server.createSession', {data})
        $('#auth-result').value = JSON.stringify(result)
        jwt = result.accessJwt
    }
    async function upload_blob() {
        if (jwt === null) return alert('missing jwt')
        let file = $('#blob').files[0]
        let result = await xrpc('com.atproto.repo.uploadBlob', {data: file})
        let repr_ele = document.createElement('li')
        repr_ele.innerText = JSON.stringify(result)
        $('#blob-list').appendChild(repr_ele)
    }
</script>
</head>
<body>
    <label for="instance">pds instance</label>
    <input id="instance" name="instance" type="text" value="network.hukoubook.com"><br>
    <label for="handle">account handle</label>
    <input id="handle" name="handle" type="text" value="testfirst.hukoubook.com"><br>
    <label for="password">app password</label>
    <input id="password" name="password" type="password"><br>
    <button onclick="auth()">auth</button>
    <p id="auth-result"></p>
    <label for="blob">blob upload</label>
    <input id="blob" name="blob" type="file"><br>
    <button onclick="upload_blob()">upload</button>
    <ol id="blob-list">
    </ol>
</body>
</html>